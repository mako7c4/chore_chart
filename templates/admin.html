<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .editing input { border: 1px solid #38bdf8 !important; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="max-w-4xl mx-auto p-4 sm:p-6">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-slate-800">Admin Dashboard</h1>
            <div>
                <a href="{{ url_for('index') }}" class="px-4 py-2 text-sm bg-teal-500 hover:bg-teal-600 text-white rounded-lg shadow transition-colors">View Chore Chart</a>
                <a href="{{ url_for('logout') }}" class="px-4 py-2 text-sm bg-slate-500 hover:bg-slate-600 text-white rounded-lg shadow transition-colors ml-2">Log Out</a>
            </div>
        </header>

        <main id="adminView" class="space-y-8 bg-white p-6 rounded-xl shadow-lg">
            <div> <h2 class="text-xl sm:text-2xl font-semibold text-slate-600 mb-3 border-b pb-2">Manage Kids</h2>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-4">
                    <input type="text" id="newKidName" placeholder="Kid's Name" class="p-2 border rounded-lg flex-grow shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                    <input type="number" id="newKidTrainTrackLength" placeholder="Track Segments (e.g., 10)" class="p-2 border rounded-lg w-full sm:w-48 shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base" min="1" value="10">
                    <button id="addKidButton" class="px-3 py-2 sm:px-4 text-sm sm:text-base bg-green-500 hover:bg-green-600 text-white rounded-lg shadow transition-colors">Add Kid</button>
                </div>
                <div id="adminKidList" class="space-y-3"></div>
            </div>

            <div> 
                <h2 class="text-xl sm:text-2xl font-semibold text-slate-600 mb-3 border-b pb-2">Manage Master Chores</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-4 mb-4 items-end">
                    <input type="text" id="newChoreName" placeholder="Chore Name" class="p-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                    <div class="flex gap-2">
                        <select id="newChoreIconSelect" class="p-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base flex-grow">
                            <option value="">-- Select Icon --</option>
                        </select>
                        <input type="text" id="newChoreIconManual" placeholder="Manual 🔧" class="p-2 border rounded-lg w-24 shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                    </div>
                    <button id="addMasterChoreButton" class="sm:col-span-2 px-3 py-2 sm:px-4 text-sm sm:text-base bg-green-500 hover:bg-green-600 text-white rounded-lg shadow transition-colors">Add Chore</button>
                </div>
                <ul id="masterChoreListDisplay" class="space-y-1 text-sm sm:text-base"></ul>
            </div>

            <div> <h2 class="text-xl sm:text-2xl font-semibold text-slate-600 mb-3 border-b pb-2">Assign Chores</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 items-end">
                    <div>
                        <label for="assignKidSelect" class="block text-xs sm:text-sm font-medium text-slate-700">Kid:</label>
                        <select id="assignKidSelect" class="p-2 border rounded-lg w-full shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                            <option value="all">All Kids</option>
                        </select>
                    </div>
                    <div>
                        <label for="assignChoreSelect" class="block text-xs sm:text-sm font-medium text-slate-700">Chore:</label>
                        <select id="assignChoreSelect" class="p-2 border rounded-lg w-full shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base"></select>
                    </div>
                    <div>
                        <label for="assignFrequencySelect" class="block text-xs sm:text-sm font-medium text-slate-700">Frequency:</label>
                        <select id="assignFrequencySelect" class="p-2 border rounded-lg w-full shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                            <option value="daily">Daily</option> <option value="weekdays">Weekdays</option> <option value="weekends">Weekends</option>
                            <option value="monday">Monday</option><option value="tuesday">Tuesday</option><option value="wednesday">Wednesday</option>
                            <option value="thursday">Thursday</option><option value="friday">Friday</option><option value="saturday">Saturday</option>
                            <option value="sunday">Sunday</option>
                        </select>
                    </div>
                    <div>
                        <label for="assignTimeframeSelect" class="block text-xs sm:text-sm font-medium text-slate-700">Timeframe:</label>
                        <select id="assignTimeframeSelect" class="p-2 border rounded-lg w-full shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                            <option value="any">All Day</option>
                            <option value="morning">Morning</option>
                            <option value="night">Night</option>
                        </select>
                    </div>
                    <button id="assignChoreButton" class="md:col-span-2 px-3 py-2 sm:px-4 text-sm sm:text-base bg-blue-500 hover:bg-blue-600 text-white rounded-lg shadow transition-colors h-10">Assign Chore</button>
                </div>
                <h3 class="text-md sm:text-lg font-semibold text-slate-600 mt-4 mb-2">Current Assignments:</h3>
                <div id="currentAssignmentsList" class="space-y-1.5 sm:space-y-2 text-xs sm:text-sm text-slate-700 max-h-32 sm:max-h-48 overflow-y-auto"></div>
            </div>

            <div> <h2 class="text-xl sm:text-2xl font-semibold text-slate-600 mb-3 border-b pb-2">Bonus Stars</h2>
                 <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 items-center">
                    <select id="bonusKidSelect" class="p-2 border rounded-lg flex-grow shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base"></select>
                    <input type="text" id="bonusReason" placeholder="Reason (optional)" class="p-2 border rounded-lg flex-grow shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                    <button id="awardBonusStarButton" class="px-3 py-2 sm:px-4 text-sm sm:text-base bg-yellow-400 hover:bg-yellow-500 text-slate-800 rounded-lg shadow transition-colors w-full sm:w-auto">Award Bonus Star</button>
                </div>
            </div>
        </main>
        
        <div id="messageModal" class="modal">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-xs sm:max-w-sm text-center">
                <p id="modalMessageText" class="text-md sm:text-lg text-slate-700 mb-4"></p>
                <button id="modalCloseButton" class="px-4 py-2 sm:px-6 text-sm sm:text-base bg-sky-500 hover:bg-sky-600 text-white rounded-lg">OK</button>
            </div>
        </div>
        <div id="editAssignmentModal" class="edit-modal">
            <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-md text-left">
                <h3 class="text-lg sm:text-xl font-semibold text-slate-700 mb-4">Edit Assignment</h3>
                <input type="hidden" id="editingAssignmentId">
                <div class="space-y-4">
                    <div>
                        <label for="editAssignmentFrequencySelect" class="block text-xs sm:text-sm font-medium text-slate-700">Frequency:</label>
                        <select id="editAssignmentFrequencySelect" class="p-2 border rounded-lg w-full shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base mt-1">
                            <option value="daily">Daily</option> <option value="weekdays">Weekdays</option> <option value="weekends">Weekends</option>
                            <option value="monday">Monday</option><option value="tuesday">Tuesday</option><option value="wednesday">Wednesday</option>
                            <option value="thursday">Thursday</option><option value="friday">Friday</option><option value="saturday">Saturday</option>
                            <option value="sunday">Sunday</option>
                        </select>
                    </div>
                    <div>
                        <label for="editAssignmentTimeframeSelect" class="block text-xs sm:text-sm font-medium text-slate-700">Timeframe:</label>
                        <select id="editAssignmentTimeframeSelect" class="p-2 border rounded-lg w-full shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base mt-1">
                            <option value="any">All Day</option>
                            <option value="morning">Morning</option>
                            <option value="night">Night</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="editAssignmentCancelButton" class="px-4 py-2 text-sm sm:text-base bg-slate-300 hover:bg-slate-400 text-slate-700 rounded-lg">Cancel</button>
                    <button id="editAssignmentSaveButton" class="px-4 py-2 text-sm sm:text-base bg-sky-500 hover:bg-sky-600 text-white rounded-lg">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        
        // --- DOM Elements (Admin-specific) ---
        const newKidNameInput = document.getElementById('newKidName');
        const adminKidListDiv = document.getElementById('adminKidList');
        const addMasterChoreButton = document.getElementById('addMasterChoreButton');
        const addKidButton = document.getElementById('addKidButton');
        const newKidTrainTrackLengthInput = document.getElementById('newKidTrainTrackLength');
        const newChoreNameInput = document.getElementById('newChoreName');
        const newChoreIconSelect = document.getElementById('newChoreIconSelect');
        const newChoreIconManual = document.getElementById('newChoreIconManual');
        const masterChoreListDisplay = document.getElementById('masterChoreListDisplay');
        const assignKidSelect = document.getElementById('assignKidSelect');
        const assignChoreSelect = document.getElementById('assignChoreSelect');
        const assignFrequencySelect = document.getElementById('assignFrequencySelect');
        const assignTimeframeSelect = document.getElementById('assignTimeframeSelect');
        const assignChoreButton = document.getElementById('assignChoreButton');
        const currentAssignmentsList = document.getElementById('currentAssignmentsList');
        const bonusKidSelect = document.getElementById('bonusKidSelect');
        const bonusReasonInput = document.getElementById('bonusReason');
        const awardBonusStarButton = document.getElementById('awardBonusStarButton');
        const messageModal = document.getElementById('messageModal');
        const modalMessageText = document.getElementById('modalMessageText');
        const modalCloseButton = document.getElementById('modalCloseButton');
        const editAssignmentModal = document.getElementById('editAssignmentModal');
        const editingAssignmentIdInput = document.getElementById('editingAssignmentId');
        const editAssignmentFrequencySelect = document.getElementById('editAssignmentFrequencySelect');
        const editAssignmentTimeframeSelect = document.getElementById('editAssignmentTimeframeSelect');
        const editAssignmentCancelButton = document.getElementById('editAssignmentCancelButton');
        const editAssignmentSaveButton = document.getElementById('editAssignmentSaveButton');
        
        let masterChoresDataCache = [];
        const DEFAULT_CHORE_ICONS = [
            { name: "Make Bed", icon: "🛏️" }, { name: "Feed Dog", icon: "🐕" },
            { name: "Brush Teeth", icon: "🦷" }, { name: "Get Dressed", icon: "👕" },
            { name: "Clean Room", icon: "🧹" }, { name: "Eat Breakfast", icon: "🥣" },
            { name: "Homework", icon: "📚" }, { name: "Set Table", icon: "🍽️" },
            { name: "Clear Table", icon: "🍽️" }, { name: "Tidy Toys", icon: "🧸" }, 
            { name: "Read Book", icon: "📖" }, { name: "Water Plants", icon: "🪴" },
            { name: "-- Manual Icon --", icon: "" } 
        ];

        async function apiCall(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            try {
                const response = await fetch(`/api${endpoint}`, options);
                const responseData = response.status === 204 ? true : await response.json().catch(() => null);
                if (!response.ok) {
                    const errorMsg = responseData?.error || `Request failed: ${response.status}`;
                    showModal(errorMsg);
                    if (response.status === 401) {
                         window.location.href = '/login'; // Redirect to login on auth error
                    }
                    return null;
                }
                return responseData;
            } catch (error) {
                showModal('Network error or server unavailable.');
                return null;
            }
        }

        function showModal(message) { modalMessageText.textContent = message; messageModal.classList.add('active'); }
        function hideModal() { messageModal.classList.remove('active'); }
        function showEditAssignmentModal(assignmentId, currentFrequency, currentTimeframe) {
            editingAssignmentIdInput.value = assignmentId;
            editAssignmentFrequencySelect.value = currentFrequency;
            editAssignmentTimeframeSelect.value = currentTimeframe;
            editAssignmentModal.classList.add('active');
        }
        function hideEditAssignmentModal() { editAssignmentModal.classList.remove('active'); }
        
        function populateDefaultChoreIcons() {
            newChoreIconSelect.innerHTML = '<option value="">-- Quick Icon --</option>'; 
            DEFAULT_CHORE_ICONS.forEach(item => {
                const option = document.createElement('option');
                option.value = item.icon;
                option.textContent = `${item.icon} ${item.name}`;
                newChoreIconSelect.appendChild(option);
            });
        }
        
        newChoreIconSelect.addEventListener('change', () => {
            const selectedValue = newChoreIconSelect.value;
            if (selectedValue) { 
                newChoreIconManual.value = selectedValue; 
                const selectedChore = DEFAULT_CHORE_ICONS.find(c => c.icon === selectedValue);
                if (selectedChore && selectedChore.name !== "-- Manual Icon --" && !newChoreNameInput.value) {
                    newChoreNameInput.value = selectedChore.name;
                }
            } 
        });

        async function loadAndRenderAdminView() {
            const kids = await apiCall('/kids');
            masterChoresDataCache = await apiCall('/chores-master') || []; 
            const assignments = await apiCall('/assignments');
            if (!kids || !masterChoresDataCache || !assignments) return;
            const adminKidListDiv = document.getElementById('adminKidList');
            adminKidListDiv.innerHTML = '';
            let kidOptionsHTML = '<option value="all">All Kids</option>';
            kids.forEach(kid => {
                const kidItem = document.createElement('div');
                kidItem.className = 'p-3 bg-slate-100 rounded-lg shadow-sm space-y-2 kid-admin-item';
                kidItem.dataset.kidId = kid.id;
                kidItem.dataset.originalName = kid.name;
                kidItem.dataset.originalTrackLength = kid.train_track_length;
                
                kidItem.innerHTML = `
                    <div class="kid-display-mode">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-md sm:text-lg kid-name-display">${kid.name || 'N/A'}</span>
                            <span class="text-xs sm:text-sm">⭐ ${kid.stars_count || 0} | 🎈 ${kid.balloons || 0} | 🚂 Laps: ${kid.train_laps_completed || 0} (Track: <span class="kid-track-length-display">${kid.train_track_length || 10}</span>)</span>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center mt-1">
                             <button class="admin-edit-kid-btn px-2 py-1.5 text-xs sm:text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-md">Edit Kid</button>
                             <button class="admin-delete-kid-btn px-2 py-1.5 text-xs sm:text-sm bg-red-700 hover:bg-red-800 text-white rounded-md" data-kid-id="${kid.id}" data-kid-name="${kid.name || 'this kid'}">Delete Kid</button>
                        </div>
                         <div class="grid grid-cols-3 gap-2 mt-1">
                            <button class="admin-reset-chores-btn px-2 py-1.5 text-xs sm:text-sm bg-red-500 hover:bg-red-600 text-white rounded-md" data-kid-id="${kid.id}">Reset Day</button>
                            <button class="admin-decrement-balloons-btn px-2 py-1.5 text-xs sm:text-sm bg-rose-500 hover:bg-rose-600 text-white rounded-md" data-kid-id="${kid.id}">-1 🎈</button>
                            <button class="admin-decrement-stars-btn px-2 py-1.5 text-xs sm:text-sm bg-purple-500 hover:bg-purple-600 text-white rounded-md" data-kid-id="${kid.id}">-1 ⭐</button>
                        </div>
                    </div>
                    <div class="kid-edit-mode hidden space-y-2">
                        <input type="text" value="${kid.name || ''}" class="edit-kid-name-input p-2 border rounded-lg w-full shadow-sm text-sm sm:text-base">
                        <input type="number" value="${kid.train_track_length || 10}" min="1" class="edit-kid-track-input p-2 border rounded-lg w-full shadow-sm text-sm sm:text-base">
                        <div class="flex gap-2">
                            <button class="admin-save-kid-btn px-3 py-1.5 text-xs sm:text-sm bg-green-500 hover:bg-green-600 text-white rounded-md">Save</button>
                            <button class="admin-cancel-edit-kid-btn px-3 py-1.5 text-xs sm:text-sm bg-slate-400 hover:bg-slate-500 text-white rounded-md">Cancel</button>
                        </div>
                    </div>
                `;
                adminKidListDiv.appendChild(kidItem);
                kidOptionsHTML += `<option value="${kid.id}">${kid.name || 'N/A'}</option>`;
            });
            assignKidSelect.innerHTML = kidOptionsHTML;
            bonusKidSelect.innerHTML = kids.map(k => `<option value="${k.id}">${k.name || 'N/A'}</option>`).join('');

            masterChoreListDisplay.innerHTML = '';
            let choreOptionsHTML = '';
            masterChoresDataCache.forEach(chore => {
                const choreItem = document.createElement('li');
                choreItem.className = 'p-1.5 bg-slate-50 rounded border border-slate-200 flex justify-between items-center chore-master-item';
                choreItem.dataset.choreId = chore.id;
                choreItem.dataset.originalName = chore.name;
                choreItem.dataset.originalIcon = chore.icon || ''; 
                choreItem.innerHTML = `
                    <div class="chore-master-display-mode">
                        <span>${chore.icon || '🔧'} ${chore.name || 'N/A'}</span>
                        <button class="admin-edit-master-chore-btn ml-2 px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded-md">Edit</button>
                    </div>
                    <div class="chore-master-edit-mode hidden flex-grow items-center gap-2">
                        <input type="text" value="${chore.name || ''}" class="edit-master-chore-name-input p-1 border rounded-md flex-grow text-sm">
                        <input type="text" value="${chore.icon || ''}" class="edit-master-chore-icon-input p-1 border rounded-md w-16 text-sm">
                        <button class="admin-save-master-chore-btn px-2 py-1 text-xs bg-green-500 text-white rounded-md">Save</button>
                        <button class="admin-cancel-edit-master-chore-btn px-2 py-1 text-xs bg-slate-400 text-white rounded-md">Cancel</button>
                    </div>
                `;
                masterChoreListDisplay.appendChild(choreItem);
                choreOptionsHTML += `<option value="${chore.id}">${chore.name || 'N/A'}</option>`;
            });
            assignChoreSelect.innerHTML = choreOptionsHTML;
            
            renderCurrentAssignments(assignments);
        }
        function renderCurrentAssignments(assignmentsData) {  }

        document.addEventListener('DOMContentLoaded', () => {
            populateDefaultChoreIcons();
            loadAndRenderAdminView();
        });
    </script>
</body>
</html>
