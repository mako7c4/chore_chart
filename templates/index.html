<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Chore Chart V3! - Edit Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        .kid-avatar { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: white; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .star-display, .balloon-display { font-size: 1.1rem; font-weight: bold; }
        .chore-item { transition: all 0.3s ease; }
        .chore-item.completed { opacity: 0.6; text-decoration: line-through; }
        .chore-item.disabled { opacity: 0.5; background-color: #e2e8f0 !important; } /* cool-gray-200 */
        .chore-item.disabled .chore-action-btn { background-color: #94a3b8 !important; cursor: not-allowed; } /* cool-gray-400 */

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .modal, .admin-login-modal, .edit-modal { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        .modal.active, .admin-login-modal.active, .edit-modal.active { display: flex; }
        .balloon-animation { position: absolute; font-size: 2rem; animation: floatUp 1.5s ease-out forwards; pointer-events: none; z-index: 100; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.5); opacity: 1; } 100% { transform: translateY(-80px) scale(1.2); opacity: 0; } }

        .train-track-container { display: flex; align-items: center; margin-top: 8px; background-color: #e2e8f0; border-radius: 8px; padding: 4px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .track-segment { width: 20px; height: 20px; background-color: #94a3b8; margin: 0 2px; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: white; transition: background-color 0.3s ease; }
        .track-segment.active { background-color: #fbbf24; } 
        .track-segment.empty { background-color: #cbd5e1; }
        .train-icon { font-size: 1rem; }
        .laps-display { font-size: 0.9rem; color: #475569; margin-left: 8px; font-weight: 500; }
        .editing input { border: 1px solid #38bdf8 !important; /* sky-500 */ }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-400 to-blue-600 min-h-screen flex flex-col items-center justify-center p-2 sm:p-4 selection:bg-yellow-300 selection:text-yellow-900">

    <div id="app-container" class="bg-white/90 backdrop-blur-md shadow-2xl rounded-xl p-4 sm:p-6 w-full max-w-2xl min-h-[85vh] max-h-[95vh] sm:min-h-[80vh] sm:max-h-[90vh] flex flex-col">
        <header class="mb-4 sm:mb-6 flex justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-slate-700">üöÇ Chore Express! üåü</h1>
            <div>
                <button id="adminModeButton" class="px-3 py-1.5 sm:px-4 sm:py-2 text-sm sm:text-base bg-amber-500 hover:bg-amber-600 text-white rounded-lg shadow transition-colors">Admin</button>
                <button id="kidSelectionButton" class="px-3 py-1.5 sm:px-4 sm:py-2 text-sm sm:text-base bg-teal-500 hover:bg-teal-600 text-white rounded-lg shadow transition-colors ml-2 hidden">Kids</button>
            </div>
        </header>

        <main class="flex-grow overflow-y-auto p-1 sm:p-2 -m-1 sm:-m-2 relative">
            <div id="kidSelectionView">
                <h2 class="text-xl sm:text-2xl font-semibold text-slate-600 mb-4 text-center">Who are you?</h2>
                <div id="kidList" class="grid grid-cols-1 gap-4"></div>
                <p id="noKidsMessage" class="text-center text-slate-500 mt-6">Admin needs to add kids first!</p>
            </div>

            <div id="kidChoresView" class="hidden">
                <div class="flex items-center mb-1">
                    <div id="kidChoresAvatar" class="kid-avatar bg-pink-500 mr-3 sm:mr-4"></div>
                    <div>
                        <h2 id="kidNameDisplay" class="text-xl sm:text-2xl font-semibold text-slate-700"></h2>
                        <div class="flex space-x-3 sm:space-x-4">
                             <p id="kidStarsDisplay" class="star-display text-yellow-500">‚≠ê 0 Stars</p>
                             <p id="kidBalloonsDisplay" class="balloon-display text-red-500">üéà 0 Balloons</p>
                        </div>
                    </div>
                </div>
                <h3 class="text-lg sm:text-xl font-semibold text-slate-600 my-2 sm:my-3">Today's Chores: <span id="currentDateDisplay"></span></h3>
                <div id="choresForKidList" class="space-y-2 sm:space-y-3"></div>
                <p id="noChoresForKidMessage" class="text-center text-slate-500 mt-6">No chores assigned for today, yay!</p>
                <p id="allChoresDoneMessage" class="text-center text-green-600 font-semibold text-lg sm:text-xl mt-6 hidden">üéâ All chores done for today! Great job! üéâ</p>
            </div>

            <div id="adminView" class="hidden space-y-6 sm:space-y-8">
                <div> <h2 class="text-xl sm:text-2xl font-semibold text-slate-600 mb-3 border-b pb-2">Manage Kids</h2>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-4">
                        <input type="text" id="newKidName" placeholder="Kid's Name" class="p-2 border rounded-lg flex-grow shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                        <input type="number" id="newKidTrainTrackLength" placeholder="Track Segments (e.g., 10)" class="p-2 border rounded-lg w-full sm:w-48 shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base" min="1" value="10">
                        <button id="addKidButton" class="px-3 py-2 sm:px-4 text-sm sm:text-base bg-green-500 hover:bg-green-600 text-white rounded-lg shadow transition-colors">Add Kid</button>
                    </div>
                    <div id="adminKidList" class="space-y-3"></div>
                </div>

                <div> <h2 class="text-xl sm:text-2xl font-semibold text-slate-600 mb-3 border-b pb-2">Manage Master Chores</h2>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-4">
                        <input type="text" id="newChoreName" placeholder="Chore Name" class="p-2 border rounded-lg flex-grow shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                        <input type="text" id="newChoreIcon" placeholder="Icon (e.g., üõèÔ∏è)" class="p-2 border rounded-lg w-full sm:w-24 shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                        <button id="addMasterChoreButton" class="px-3 py-2 sm:px-4 text-sm sm:text-base bg-green-500 hover:bg-green-600 text-white rounded-lg shadow transition-colors">Add Chore</button>
                    </div>
                    <ul id="masterChoreListDisplay" class="space-y-1 text-sm sm:text-base"></ul>
                </div>

                <div> <h2 class="text-xl sm:text-2xl font-semibold text-slate-600 mb-3 border-b pb-2">Assign Chores</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 items-end">
                        <div>
                            <label for="assignKidSelect" class="block text-xs sm:text-sm font-medium text-slate-700">Kid:</label>
                            <select id="assignKidSelect" class="p-2 border rounded-lg w-full shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                                <option value="all">All Kids</option>
                            </select>
                        </div>
                        <div>
                            <label for="assignChoreSelect" class="block text-xs sm:text-sm font-medium text-slate-700">Chore:</label>
                            <select id="assignChoreSelect" class="p-2 border rounded-lg w-full shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base"></select>
                        </div>
                        <div>
                            <label for="assignFrequencySelect" class="block text-xs sm:text-sm font-medium text-slate-700">Frequency:</label>
                            <select id="assignFrequencySelect" class="p-2 border rounded-lg w-full shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                                <option value="daily">Daily</option> <option value="weekdays">Weekdays</option> <option value="weekends">Weekends</option>
                                <option value="monday">Monday</option><option value="tuesday">Tuesday</option><option value="wednesday">Wednesday</option>
                                <option value="thursday">Thursday</option><option value="friday">Friday</option><option value="saturday">Saturday</option>
                                <option value="sunday">Sunday</option>
                            </select>
                        </div>
                        <button id="assignChoreButton" class="px-3 py-2 sm:px-4 text-sm sm:text-base bg-blue-500 hover:bg-blue-600 text-white rounded-lg shadow transition-colors h-10">Assign</button>
                    </div>
                    <h3 class="text-md sm:text-lg font-semibold text-slate-600 mt-4 mb-2">Current Assignments:</h3>
                    <div id="currentAssignmentsList" class="space-y-1.5 sm:space-y-2 text-xs sm:text-sm text-slate-700 max-h-32 sm:max-h-48 overflow-y-auto"></div>
                </div>

                <div> <h2 class="text-xl sm:text-2xl font-semibold text-slate-600 mb-3 border-b pb-2">Bonus Stars</h2>
                     <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 items-center">
                        <select id="bonusKidSelect" class="p-2 border rounded-lg flex-grow shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base"></select>
                        <input type="text" id="bonusReason" placeholder="Reason (optional)" class="p-2 border rounded-lg flex-grow shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                        <button id="awardBonusStarButton" class="px-3 py-2 sm:px-4 text-sm sm:text-base bg-yellow-400 hover:bg-yellow-500 text-slate-800 rounded-lg shadow transition-colors w-full sm:w-auto">Award Bonus Star</button>
                    </div>
                </div>
            </div>
        </main>

        <div id="adminLoginModal" class="admin-login-modal">
            <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-xs sm:max-w-sm text-center">
                <h3 class="text-lg sm:text-xl font-semibold text-slate-700 mb-4">Admin Access</h3>
                <input type="password" id="adminPasswordInput" placeholder="Enter Admin Password" class="p-2 border rounded-lg w-full mb-4 shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base">
                <button id="adminLoginSubmitButton" class="px-4 py-2 sm:px-6 text-sm sm:text-base bg-sky-500 hover:bg-sky-600 text-white rounded-lg w-full mb-2">Login</button>
                <button id="adminLoginCancelButton" class="px-4 py-2 sm:px-6 text-sm sm:text-base bg-slate-300 hover:bg-slate-400 text-slate-700 rounded-lg w-full">Cancel</button>
            </div>
        </div>
        
        <div id="messageModal" class="modal">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-xs sm:max-w-sm text-center">
                <p id="modalMessageText" class="text-md sm:text-lg text-slate-700 mb-4"></p>
                <button id="modalCloseButton" class="px-4 py-2 sm:px-6 text-sm sm:text-base bg-sky-500 hover:bg-sky-600 text-white rounded-lg">OK</button>
            </div>
        </div>

        <div id="editAssignmentModal" class="edit-modal">
            <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-md text-left">
                <h3 class="text-lg sm:text-xl font-semibold text-slate-700 mb-4">Edit Assignment</h3>
                <input type="hidden" id="editingAssignmentId">
                <div>
                    <label for="editAssignmentFrequencySelect" class="block text-xs sm:text-sm font-medium text-slate-700">New Frequency:</label>
                    <select id="editAssignmentFrequencySelect" class="p-2 border rounded-lg w-full shadow-sm focus:ring-2 focus:ring-sky-500 outline-none text-sm sm:text-base mt-1">
                        <option value="daily">Daily</option> <option value="weekdays">Weekdays</option> <option value="weekends">Weekends</option>
                        <option value="monday">Monday</option><option value="tuesday">Tuesday</option><option value="wednesday">Wednesday</option>
                        <option value="thursday">Thursday</option><option value="friday">Friday</option><option value="saturday">Saturday</option>
                        <option value="sunday">Sunday</option>
                    </select>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="editAssignmentCancelButton" class="px-4 py-2 text-sm sm:text-base bg-slate-300 hover:bg-slate-400 text-slate-700 rounded-lg">Cancel</button>
                    <button id="editAssignmentSaveButton" class="px-4 py-2 text-sm sm:text-base bg-sky-500 hover:bg-sky-600 text-white rounded-lg">Save Changes</button>
                </div>
            </div>
        </div>


    </div>

    <script>
        // --- DOM Elements ---
        const adminModeButton = document.getElementById('adminModeButton');
        const kidSelectionButton = document.getElementById('kidSelectionButton');
        const kidSelectionView = document.getElementById('kidSelectionView');
        const kidChoresView = document.getElementById('kidChoresView');
        const adminView = document.getElementById('adminView');
        const kidListDiv = document.getElementById('kidList');
        const noKidsMessage = document.getElementById('noKidsMessage');
        const kidChoresAvatar = document.getElementById('kidChoresAvatar');
        const kidNameDisplay = document.getElementById('kidNameDisplay');
        const kidStarsDisplay = document.getElementById('kidStarsDisplay');
        const kidBalloonsDisplay = document.getElementById('kidBalloonsDisplay');
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const choresForKidList = document.getElementById('choresForKidList');
        const noChoresForKidMessage = document.getElementById('noChoresForKidMessage');
        const allChoresDoneMessage = document.getElementById('allChoresDoneMessage');
        const newKidNameInput = document.getElementById('newKidName');
        const newKidTrainTrackLengthInput = document.getElementById('newKidTrainTrackLength');
        const addKidButton = document.getElementById('addKidButton');
        const adminKidListDiv = document.getElementById('adminKidList');
        const newChoreNameInput = document.getElementById('newChoreName');
        const newChoreIconInput = document.getElementById('newChoreIcon');
        const addMasterChoreButton = document.getElementById('addMasterChoreButton');
        const masterChoreListDisplay = document.getElementById('masterChoreListDisplay');
        const assignKidSelect = document.getElementById('assignKidSelect');
        const assignChoreSelect = document.getElementById('assignChoreSelect');
        const assignFrequencySelect = document.getElementById('assignFrequencySelect');
        const assignChoreButton = document.getElementById('assignChoreButton');
        const currentAssignmentsList = document.getElementById('currentAssignmentsList');
        const bonusKidSelect = document.getElementById('bonusKidSelect');
        const bonusReasonInput = document.getElementById('bonusReason');
        const awardBonusStarButton = document.getElementById('awardBonusStarButton');
        const messageModal = document.getElementById('messageModal');
        const modalMessageText = document.getElementById('modalMessageText');
        const modalCloseButton = document.getElementById('modalCloseButton');
        const adminLoginModal = document.getElementById('adminLoginModal');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const adminLoginSubmitButton = document.getElementById('adminLoginSubmitButton');
        const adminLoginCancelButton = document.getElementById('adminLoginCancelButton');
        // Edit Assignment Modal Elements
        const editAssignmentModal = document.getElementById('editAssignmentModal');
        const editingAssignmentIdInput = document.getElementById('editingAssignmentId');
        const editAssignmentFrequencySelect = document.getElementById('editAssignmentFrequencySelect');
        const editAssignmentCancelButton = document.getElementById('editAssignmentCancelButton');
        const editAssignmentSaveButton = document.getElementById('editAssignmentSaveButton');


        // --- State ---
        let currentKidId = null;
        let currentView = 'kidSelection';
        let adminPassword = null; 
        const KID_AVATAR_COLORS = ['bg-pink-500', 'bg-indigo-500', 'bg-emerald-500', 'bg-purple-500', 'bg-orange-500'];
        let masterChoresDataCache = []; // Cache for master chores to populate edit selects

        // --- API Helper ---
        async function apiCall(endpoint, method = 'GET', body = null, requiresAdmin = false) {
            const headers = { 'Content-Type': 'application/json' };
            if (requiresAdmin && adminPassword) {
                headers['X-Admin-Password'] = adminPassword;
            }
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            try {
                const response = await fetch(`/api${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP error! Status: ${response.status}` }));
                    console.error('API Error:', errorData.error, response.status);
                    showModal(errorData.error || `Request failed: ${response.status}`);
                    if (response.status === 401 && requiresAdmin) {
                        adminPassword = null; switchView('kidSelection'); showAdminLogin();
                    }
                    return null;
                }
                if (response.status === 204) return true; // No Content success
                return await response.json();
            } catch (error) {
                console.error('Fetch Error:', error);
                showModal('Network error or server unavailable.');
                return null;
            }
        }

        // --- Modal Functions ---
        function showModal(message) { modalMessageText.textContent = message; messageModal.classList.add('active'); }
        function hideModal() { messageModal.classList.remove('active'); }
        function showAdminLogin() { adminPasswordInput.value = ''; adminLoginModal.classList.add('active'); }
        function hideAdminLogin() { adminLoginModal.classList.remove('active'); }
        function showEditAssignmentModal(assignmentId, currentFrequency) {
            editingAssignmentIdInput.value = assignmentId;
            editAssignmentFrequencySelect.value = currentFrequency;
            editAssignmentModal.classList.add('active');
        }
        function hideEditAssignmentModal() {
            editAssignmentModal.classList.remove('active');
        }


        // --- View Switching ---
        function switchView(viewName) {
            currentView = viewName;
            [kidSelectionView, kidChoresView, adminView].forEach(v => v.classList.add('hidden'));
            kidSelectionButton.classList.add('hidden');
            adminModeButton.classList.remove('hidden');
            if (viewName === 'kidSelection') {
                kidSelectionView.classList.remove('hidden'); loadAndRenderKidSelectionView();
            } else if (viewName === 'kidChores') {
                kidChoresView.classList.remove('hidden'); kidSelectionButton.classList.remove('hidden');
                loadAndRenderKidChoresView(currentKidId);
            } else if (viewName === 'admin') {
                if (!adminPassword) { showAdminLogin(); return; }
                adminView.classList.remove('hidden'); kidSelectionButton.classList.remove('hidden');
                adminModeButton.classList.add('hidden'); loadAndRenderAdminView();
            }
        }
        
        function triggerBalloonAnimation(element) { /* ... (same as before) */ }

        function renderTrainTrack(kid) { /* ... (same as before) */ }

        // --- Rendering Functions ---
        async function loadAndRenderKidSelectionView() { /* ... (same as before, uses renderTrainTrack) */ 
            const kids = await apiCall('/kids');
            kidListDiv.innerHTML = '';
            if (!kids || kids.length === 0) {
                noKidsMessage.classList.remove('hidden'); kidListDiv.classList.add('hidden');
            } else {
                noKidsMessage.classList.add('hidden'); kidListDiv.classList.remove('hidden');
                kids.forEach(kid => {
                    const kidCard = document.createElement('div');
                    kidCard.className = `p-3 sm:p-4 rounded-xl shadow-lg text-white cursor-pointer hover:scale-105 transition-transform ${kid.avatar_color || 'bg-sky-500'}`;
                    kidCard.onclick = () => { currentKidId = kid.id; switchView('kidChores'); };
                    const kidInfoDiv = document.createElement('div');
                    kidInfoDiv.className = 'flex items-center mb-2';
                    const avatar = document.createElement('div');
                    avatar.className = `kid-avatar mr-3 ${kid.avatar_color || 'bg-sky-500'}`; 
                    avatar.textContent = kid.name.charAt(0).toUpperCase();
                    kidInfoDiv.appendChild(avatar);
                    const nameText = document.createElement('p');
                    nameText.className = 'text-lg sm:text-xl font-semibold';
                    nameText.textContent = kid.name;
                    kidInfoDiv.appendChild(nameText);
                    kidCard.appendChild(kidInfoDiv);
                    const trainTrackElement = renderTrainTrack(kid);
                    kidCard.appendChild(trainTrackElement);
                    kidListDiv.appendChild(kidCard);
                });
            }
        }

        async function loadAndRenderKidChoresView(kidId) { /* ... (same as before) */ 
            if (!kidId) { switchView('kidSelection'); return; }
            const data = await apiCall(`/kids/${kidId}/chores-today`);
            if (!data || !data.kid_info) { switchView('kidSelection'); return; }
            const { kid_info, chores } = data;
            kidNameDisplay.textContent = kid_info.name;
            kidChoresAvatar.className = `kid-avatar ${kid_info.avatar_color || 'bg-pink-500'} mr-3 sm:mr-4`;
            kidChoresAvatar.textContent = kid_info.name.charAt(0).toUpperCase();
            kidStarsDisplay.innerHTML = `‚≠ê ${kid_info.stars_count} Star${kid_info.stars_count === 1 ? '' : 's'}`;
            kidBalloonsDisplay.innerHTML = `üéà ${kid_info.balloons} Balloon${kid_info.balloons === 1 ? '' : 's'}`;
            currentDateDisplay.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            choresForKidList.innerHTML = '';
            if (chores.length === 0) {
                noChoresForKidMessage.classList.remove('hidden'); allChoresDoneMessage.classList.add('hidden');
            } else {
                noChoresForKidMessage.classList.add('hidden');
                let allMarkedComplete = true;
                chores.forEach(chore => {
                    const isCompleted = chore.completed_today;
                    const choreDiv = document.createElement('div');
                    // chore.is_active is not directly available here, but backend filters.
                    // If we wanted to show disabled chores differently, we'd need that info.
                    choreDiv.className = `chore-item flex items-center justify-between p-3 sm:p-4 bg-slate-100 rounded-lg shadow ${isCompleted ? 'completed' : ''}`;
                    choreDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-xl sm:text-2xl mr-2 sm:mr-3">${chore.chore_icon || 'üîß'}</span>
                            <span class="text-slate-700 text-sm sm:text-base">${chore.chore_name}</span>
                        </div>
                        <button data-assignment-id="${chore.assignment_id}" data-chore-id="${chore.chore_id}" 
                                class="chore-action-btn px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg text-white transition-colors text-xs sm:text-sm
                                       ${isCompleted ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'}">
                            ${isCompleted ? 'Undo' : 'Mark Done'}
                        </button>
                    `;
                    choresForKidList.appendChild(choreDiv);
                    if (!isCompleted) allMarkedComplete = false;
                });
                allChoresDoneMessage.classList.toggle('hidden', !allMarkedComplete);
            }
        }

        async function loadAndRenderAdminView() {
            const kids = await apiCall('/kids', 'GET', null, true);
            masterChoresDataCache = await apiCall('/chores-master', 'GET', null, true) || []; // Update cache
            const assignments = await apiCall('/assignments', 'GET', null, true);
            if (!kids || !masterChoresDataCache || !assignments) return;

            // Render Kids with Edit
            adminKidListDiv.innerHTML = '';
            let kidOptionsHTML = '<option value="all">All Kids</option>';
            kids.forEach(kid => {
                const kidItem = document.createElement('div');
                kidItem.className = 'p-3 bg-slate-100 rounded-lg shadow-sm space-y-2 kid-admin-item';
                kidItem.dataset.kidId = kid.id;
                kidItem.dataset.originalName = kid.name;
                kidItem.dataset.originalTrackLength = kid.train_track_length;
                
                kidItem.innerHTML = `
                    <div class="kid-display-mode">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-md sm:text-lg kid-name-display">${kid.name}</span>
                            <span class="text-xs sm:text-sm">‚≠ê ${kid.stars_count} | üéà ${kid.balloons} | üöÇ Laps: ${kid.train_laps_completed} (Track: <span class="kid-track-length-display">${kid.train_track_length}</span>)</span>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 items-center mt-1">
                            <input type="number" value="${kid.train_track_length}" min="1" class="admin-kid-train-length p-1.5 border rounded-md w-full sm:w-24 text-xs sm:text-sm hidden" placeholder="Track Len">
                            <button class="admin-edit-kid-btn px-2 py-1.5 text-xs sm:text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-md w-full sm:w-auto">Edit Kid</button>
                        </div>
                         <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-1">
                            <button class="admin-reset-chores-btn px-2 py-1.5 text-xs sm:text-sm bg-red-500 hover:bg-red-600 text-white rounded-md" data-kid-id="${kid.id}">Reset Day</button>
                            <button class="admin-decrement-balloons-btn px-2 py-1.5 text-xs sm:text-sm bg-rose-500 hover:bg-rose-600 text-white rounded-md" data-kid-id="${kid.id}">-1 üéà</button>
                            <button class="admin-decrement-stars-btn px-2 py-1.5 text-xs sm:text-sm bg-purple-500 hover:bg-purple-600 text-white rounded-md" data-kid-id="${kid.id}">-1 ‚≠ê</button>
                        </div>
                    </div>
                    <div class="kid-edit-mode hidden space-y-2">
                        <input type="text" value="${kid.name}" class="edit-kid-name-input p-2 border rounded-lg w-full shadow-sm text-sm sm:text-base">
                        <input type="number" value="${kid.train_track_length}" min="1" class="edit-kid-track-input p-2 border rounded-lg w-full shadow-sm text-sm sm:text-base">
                        <div class="flex gap-2">
                            <button class="admin-save-kid-btn px-3 py-1.5 text-xs sm:text-sm bg-green-500 hover:bg-green-600 text-white rounded-md">Save</button>
                            <button class="admin-cancel-edit-kid-btn px-3 py-1.5 text-xs sm:text-sm bg-slate-400 hover:bg-slate-500 text-white rounded-md">Cancel</button>
                        </div>
                    </div>
                `;
                adminKidListDiv.appendChild(kidItem);
                kidOptionsHTML += `<option value="${kid.id}">${kid.name}</option>`;
            });
            assignKidSelect.innerHTML = kidOptionsHTML;
            bonusKidSelect.innerHTML = kids.map(k => `<option value="${k.id}">${k.name}</option>`).join('');

            // Render Master Chores with Edit
            masterChoreListDisplay.innerHTML = '';
            let choreOptionsHTML = '';
            masterChoresDataCache.forEach(chore => {
                const choreItem = document.createElement('li');
                choreItem.className = 'p-1.5 bg-slate-50 rounded border border-slate-200 flex justify-between items-center chore-master-item';
                choreItem.dataset.choreId = chore.id;
                choreItem.dataset.originalName = chore.name;
                choreItem.dataset.originalIcon = chore.icon || '';
                choreItem.innerHTML = `
                    <div class="chore-master-display-mode">
                        <span>${chore.icon || 'üîß'} ${chore.name}</span>
                        <button class="admin-edit-master-chore-btn ml-2 px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded-md">Edit</button>
                    </div>
                    <div class="chore-master-edit-mode hidden flex-grow items-center gap-2">
                        <input type="text" value="${chore.name}" class="edit-master-chore-name-input p-1 border rounded-md flex-grow text-sm">
                        <input type="text" value="${chore.icon || ''}" class="edit-master-chore-icon-input p-1 border rounded-md w-16 text-sm">
                        <button class="admin-save-master-chore-btn px-2 py-1 text-xs bg-green-500 text-white rounded-md">Save</button>
                        <button class="admin-cancel-edit-master-chore-btn px-2 py-1 text-xs bg-slate-400 text-white rounded-md">Cancel</button>
                    </div>
                `;
                masterChoreListDisplay.appendChild(choreItem);
                choreOptionsHTML += `<option value="${chore.id}">${chore.name}</option>`;
            });
            assignChoreSelect.innerHTML = choreOptionsHTML;
            
            renderCurrentAssignments(assignments); // Render assignments with new edit/toggle buttons
        }

        function renderCurrentAssignments(assignmentsData) {
            currentAssignmentsList.innerHTML = '';
            if (!assignmentsData || assignmentsData.length === 0) {
                currentAssignmentsList.innerHTML = '<p class="text-slate-500">No chores assigned yet.</p>'; return;
            }
            assignmentsData.forEach(assignment => {
                const div = document.createElement('div');
                const isActive = assignment.is_active;
                div.className = `p-1.5 sm:p-2 bg-slate-50 rounded border border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center ${!isActive ? 'opacity-50' : ''}`;
                div.innerHTML = `
                    <div>
                        <span><strong>${assignment.kid_name}</strong> - ${assignment.chore_name}</span>
                        <span class="block sm:inline sm:ml-2 text-slate-600 text-xs">(${assignment.frequency}) ${!isActive ? '[DISABLED]' : ''}</span>
                    </div>
                    <div class="flex gap-1 sm:gap-2 mt-1 sm:mt-0">
                        <button data-assignment-id="${assignment.id}" data-current-frequency="${assignment.frequency}" class="admin-edit-assignment-btn px-2 py-1 text-xs bg-sky-500 hover:bg-sky-600 text-white rounded-md">Edit Freq</button>
                        <button data-assignment-id="${assignment.id}" class="admin-toggle-assignment-active-btn px-2 py-1 text-xs ${isActive ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded-md">${isActive ? 'Disable' : 'Enable'}</button>
                        <button data-assignment-id="${assignment.id}" class="remove-assignment-btn px-2 py-1 text-xs bg-red-500 hover:bg-red-600 text-white rounded-md">Remove</button>
                    </div>
                `;
                currentAssignmentsList.appendChild(div);
            });
        }


        // --- Event Handlers ---
        adminLoginSubmitButton.onclick = () => { /* ... (same) */ };
        adminLoginCancelButton.onclick = () => { /* ... (same) */ };
        addKidButton.onclick = async () => { /* ... (same, ensure loadAndRenderAdminView is called) */ };
        addMasterChoreButton.onclick = async () => { /* ... (same, ensure loadAndRenderAdminView is called) */ };
        assignChoreButton.onclick = async () => { /* ... (same, ensure loadAndRenderAdminView is called) */ };
        awardBonusStarButton.onclick = async () => { /* ... (same, ensure loadAndRenderAdminView and kid's view are called) */ };
        choresForKidList.addEventListener('click', async (e) => { /* ... (same chore action logic) */ });
        
        // Edit Kid Logic
        adminKidListDiv.addEventListener('click', async (e) => {
            const kidItem = e.target.closest('.kid-admin-item');
            if (!kidItem) return;
            const kidId = kidItem.dataset.kidId;

            if (e.target.classList.contains('admin-edit-kid-btn')) {
                kidItem.querySelector('.kid-display-mode').classList.add('hidden');
                kidItem.querySelector('.kid-edit-mode').classList.remove('hidden');
            } else if (e.target.classList.contains('admin-cancel-edit-kid-btn')) {
                kidItem.querySelector('.kid-display-mode').classList.remove('hidden');
                kidItem.querySelector('.kid-edit-mode').classList.add('hidden');
                // Reset input fields to original values
                kidItem.querySelector('.edit-kid-name-input').value = kidItem.dataset.originalName;
                kidItem.querySelector('.edit-kid-track-input').value = kidItem.dataset.originalTrackLength;
            } else if (e.target.classList.contains('admin-save-kid-btn')) {
                const newName = kidItem.querySelector('.edit-kid-name-input').value.trim();
                const newTrackLength = parseInt(kidItem.querySelector('.edit-kid-track-input').value);
                if (newName && newTrackLength > 0) {
                    const result = await apiCall(`/kids/${kidId}`, 'PUT', { name: newName, train_track_length: newTrackLength }, true);
                    if (result) {
                        showModal('Kid updated successfully!');
                        loadAndRenderAdminView(); // Reload to reflect changes and exit edit mode
                        if (currentView === 'kidChores' && currentKidId == kidId) loadAndRenderKidChoresView(kidId); // Refresh kid view if active
                    }
                } else { showModal('Valid name and positive track length required.'); }
            }
            // Other admin buttons for kid (reset, decrement) - ensure they use kidId from kidItem.dataset.kidId
            else if (e.target.classList.contains('admin-reset-chores-btn')) { /* ... (same as before, use kidId) */ }
            else if (e.target.classList.contains('admin-decrement-balloons-btn')) { /* ... (same as before, use kidId) */ }
            else if (e.target.classList.contains('admin-decrement-stars-btn')) { /* ... (same as before, use kidId) */ }
        });

        // Edit Master Chore Logic
        masterChoreListDisplay.addEventListener('click', async (e) => {
            const choreItem = e.target.closest('.chore-master-item');
            if (!choreItem) return;
            const choreId = choreItem.dataset.choreId;

            if (e.target.classList.contains('admin-edit-master-chore-btn')) {
                choreItem.querySelector('.chore-master-display-mode').classList.add('hidden');
                choreItem.querySelector('.chore-master-edit-mode').classList.remove('hidden');
            } else if (e.target.classList.contains('admin-cancel-edit-master-chore-btn')) {
                choreItem.querySelector('.chore-master-display-mode').classList.remove('hidden');
                choreItem.querySelector('.chore-master-edit-mode').classList.add('hidden');
                choreItem.querySelector('.edit-master-chore-name-input').value = choreItem.dataset.originalName;
                choreItem.querySelector('.edit-master-chore-icon-input').value = choreItem.dataset.originalIcon;
            } else if (e.target.classList.contains('admin-save-master-chore-btn')) {
                const newName = choreItem.querySelector('.edit-master-chore-name-input').value.trim();
                const newIcon = choreItem.querySelector('.edit-master-chore-icon-input').value.trim();
                if (newName) {
                    const result = await apiCall(`/chores-master/${choreId}`, 'PUT', { name: newName, icon: newIcon }, true);
                    if (result) {
                        showModal('Master chore updated!');
                        loadAndRenderAdminView(); // Reload
                    }
                } else { showModal('Chore name cannot be empty.'); }
            }
        });
        
        // Edit/Toggle/Remove Assignment Logic
        currentAssignmentsList.addEventListener('click', async (e) => {
            const assignmentId = e.target.dataset.assignmentId;
            if (!assignmentId) return;

            if (e.target.classList.contains('remove-assignment-btn')) {
                if (confirm('Are you sure you want to remove this assignment?')) {
                    if (await apiCall(`/assignments/${assignmentId}`, 'DELETE', null, true)) {
                        loadAndRenderAdminView(); showModal('Assignment removed.');
                    }
                }
            } else if (e.target.classList.contains('admin-toggle-assignment-active-btn')) {
                const result = await apiCall(`/assignments/${assignmentId}/toggle-active`, 'POST', null, true);
                if (result) {
                    showModal(result.message);
                    loadAndRenderAdminView(); // Refresh the list to show new status
                }
            } else if (e.target.classList.contains('admin-edit-assignment-btn')) {
                const currentFrequency = e.target.dataset.currentFrequency;
                showEditAssignmentModal(assignmentId, currentFrequency);
            }
        });

        editAssignmentSaveButton.onclick = async () => {
            const assignmentId = editingAssignmentIdInput.value;
            const newFrequency = editAssignmentFrequencySelect.value;
            if (assignmentId && newFrequency) {
                const result = await apiCall(`/assignments/${assignmentId}/edit`, 'PUT', { frequency: newFrequency }, true);
                if (result) {
                    showModal(result.message);
                    hideEditAssignmentModal();
                    loadAndRenderAdminView();
                }
            }
        };
        editAssignmentCancelButton.onclick = hideEditAssignmentModal;


        // --- Navigation & Initial Load ---
        adminModeButton.onclick = () => switchView('admin');
        kidSelectionButton.onclick = () => { currentKidId = null; switchView('kidSelection'); };
        modalCloseButton.onclick = hideModal;
        document.addEventListener('DOMContentLoaded', () => {
            currentDateDisplay.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            switchView('kidSelection');
        });

        // Fill in the blanks for event handlers that were previously shortened
        addKidButton.onclick = async () => {
            const name = newKidNameInput.value.trim();
            const trackLength = parseInt(newKidTrainTrackLengthInput.value) || 10;
            if (name && trackLength > 0) {
                const avatarColor = KID_AVATAR_COLORS[document.querySelectorAll('#adminKidList > div').length % KID_AVATAR_COLORS.length];
                const newKid = await apiCall('/kids', 'POST', { name, avatarColor, trainTrackLength: trackLength }, true);
                if (newKid) {
                    newKidNameInput.value = ''; newKidTrainTrackLengthInput.value = '10';
                    loadAndRenderAdminView(); showModal(`${name} added!`);
                }
            } else { showModal('Kid name and positive track length required.'); }
        };
        addMasterChoreButton.onclick = async () => { 
            const name = newChoreNameInput.value.trim(); const icon = newChoreIconInput.value.trim();
            if (name) {
                const newChore = await apiCall('/chores-master', 'POST', { name, icon }, true);
                if (newChore) { newChoreNameInput.value = ''; newChoreIconInput.value = ''; loadAndRenderAdminView(); showModal(`Chore "${name}" added!`);}
            } else { showModal('Chore name required.');}
        };
        assignChoreButton.onclick = async () => { 
            const kidId = assignKidSelect.value; const choreId = parseInt(assignChoreSelect.value); const frequency = assignFrequencySelect.value;
            if (!choreId && assignChoreSelect.options.length > 0) { showModal('Please select a chore.'); return; }
            else if (assignChoreSelect.options.length === 0) { showModal('No master chores to assign. Add some first.'); return; }
            const result = await apiCall('/assignments', 'POST', { kidId, choreId, frequency }, true);
            if (result) { loadAndRenderAdminView(); showModal(result.message || 'Chore assigned!');}
        };
         awardBonusStarButton.onclick = async () => { 
            const kidId = parseInt(bonusKidSelect.value); const reason = bonusReasonInput.value.trim();
            if (!kidId && bonusKidSelect.options.length > 0) { showModal('Please select a kid.'); return; }
            else if (bonusKidSelect.options.length === 0) { showModal('No kids to award stars.'); return; }

            const result = await apiCall('/stars/bonus', 'POST', { kidId, reason }, true);
            if (result) {
                loadAndRenderAdminView(); 
                if (currentView === 'kidChores' && currentKidId == kidId) loadAndRenderKidChoresView(kidId);
                showModal(result.message || 'Bonus star awarded!'); bonusReasonInput.value = '';
            }
        };
        choresForKidList.addEventListener('click', async (e) => {
            const button = e.target.closest('.chore-action-btn');
            if (button) {
                const assignmentId = parseInt(button.dataset.assignmentId);
                const choreId = parseInt(button.dataset.choreId); 
                const isCompleted = button.textContent.trim().toLowerCase() === 'undo';
                let result;
                if (isCompleted) { 
                    result = await apiCall('/completions/uncheck', 'POST', { kidId: currentKidId, assignmentId });
                } else { 
                    triggerBalloonAnimation(button);
                    result = await apiCall('/completions', 'POST', { kidId: currentKidId, assignmentId, choreId });
                }
                if (result) {
                    loadAndRenderKidChoresView(currentKidId); 
                    if (result.daily_star_awarded) showModal("Great job! You earned a daily star! ‚≠ê");
                    else if (result.stars_from_balloons > 0) showModal(`Wow! You converted balloons into ${result.stars_from_balloons} star(s)! ‚≠ê`);
                    else if (result.daily_star_revoked) showModal("Daily star was un-earned.");
                    else if (result.star_from_balloons_revoked) showModal("Balloon-star was un-earned and balloons returned.");
                    else if (result.message) showModal(result.message);
                }
            }
        });
        adminLoginSubmitButton.onclick = () => {
            const pwd = adminPasswordInput.value; if (!pwd) { showModal("Please enter admin password."); return; }
            adminPassword = pwd; hideAdminLogin(); switchView('admin');
        };
        adminLoginCancelButton.onclick = hideAdminLogin;


    </script>
</body>
</html>
